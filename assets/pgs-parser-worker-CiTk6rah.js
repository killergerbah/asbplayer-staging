(function(){"use strict";var v={},H={},D={},C;function T(){if(C)return D;C=1,Object.defineProperty(D,"__esModule",{value:!0}),D.BufferReader=D.CompositeBufferReader=D.CompositeBuffer=D.Uint8ArrayBuffer=void 0;class i{constructor(o){this.buffer=o}get length(){return this.buffer.length}at(o){return this.buffer[o]}subarray(o,f){return new i(this.buffer.subarray(o,f))}}D.Uint8ArrayBuffer=i;class r{constructor(o){this.buffers=[],this.buffers=o}get length(){let o=0;for(const f of this.buffers)o+=f.length;return o}at(o){let f=0;for(const l of this.buffers){const c=o-f;if(c<l.length)return l.at(c);f+=l.length}throw new Error("Out of bounds")}subarray(o,f){const l=[];let c=0;for(const S of this.buffers){const B=Math.max(0,o-c),n=Math.min(S.length,f-c);n>0&&B<n&&l.push(S.subarray(B,n)),c+=S.length}return new r(l)}}D.CompositeBuffer=r;class d{constructor(){this.buffers=[]}add(o){this.buffers.push(o)}get length(){let o=0;for(const f of this.buffers)o+=f.length;return o}read(o){if(o===0)return new r([]);const f=[];let l=0;for(;;){if(this.buffers.length===0)throw new Error("Trying to read more bytes than available");const c=this.buffers.shift(),S=o-l;if(c.length===S){f.push(c);break}else if(c.length>S){f.push(c.subarray(0,S)),this.buffers.unshift(c.subarray(S,c.length));break}l+=c.length,f.push(c)}return new r(f.map(c=>new i(c)))}}D.CompositeBufferReader=d;class x{constructor(o){this._index=0,this.buffer=o}get index(){return this._index}get hasNext(){return this._index<this.buffer.length}readHex(o,f){if(f!==void 0&&this._index+o>f)return 0;let l=0,c=0;const S=this._index,B=this._index+o-1;for(let n=B;n>=S;--n)l+=this.buffer.at(n)<<8*c,++c;return this._index+=o,l}readBuffer(o){const f=this.buffer.subarray(this.index,this.index+o);return this._index+=o,f}}return D.BufferReader=x,D}var F={},j;function q(){return j||(j=1,function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.lastInSequenceFlagFromByte=i.LastInSequenceFlag=i.objectCroppedFlagFromByte=i.paletteUpdateFlagFromByte=i.compositionStateFromByte=i.CompositionState=i.segmentTypeFromByte=i.SegmentType=void 0;var r;(function(t){t[t.pds=20]="pds",t[t.ods=21]="ods",t[t.pcs=22]="pcs",t[t.wds=23]="wds",t[t.end=128]="end"})(r=i.SegmentType||(i.SegmentType={}));const d=Object.values(r);function x(t){for(const e of d)if(t===e)return e;throw new Error(`Invalid segment type byte: ${t}`)}i.segmentTypeFromByte=x;var y;(function(t){t[t.normal=0]="normal",t[t.acquisitionState=64]="acquisitionState",t[t.epochStart=128]="epochStart"})(y=i.CompositionState||(i.CompositionState={}));const o=Object.values(y);function f(t){for(const e of o)if(t===e)return e;throw new Error(`Invalid composition state byte: ${t}`)}i.compositionStateFromByte=f;function l(t){switch(t){case 0:return!1;case 128:return!0;default:throw new Error(`Invalid palette update flag byte: ${t}`)}}i.paletteUpdateFlagFromByte=l;function c(t){switch(t){case 0:return!1;case 64:return!0;default:throw new Error(`Invalid object cropped flag byte: ${t}`)}}i.objectCroppedFlagFromByte=c;var S;(function(t){t[t.lastInSequence=64]="lastInSequence",t[t.firstInSequence=128]="firstInSequence",t[t.firstAndLastInSequence=192]="firstAndLastInSequence"})(S=i.LastInSequenceFlag||(i.LastInSequenceFlag={}));const B=Object.values(S);function n(t){for(const e of B)if(t===e)return e;throw new Error(`Invalid last in sequence flag byte: ${t}`)}i.lastInSequenceFlagFromByte=n}(F)),F}var P;function O(){if(P)return H;P=1,Object.defineProperty(H,"__esModule",{value:!0}),H.DisplaySet=H.parseDisplaySets=void 0;const i=T(),r=q(),d=20551;function x(){const n=new f,t=new i.CompositeBufferReader;let e=13;return new TransformStream({transform(s,a){for(t.add(s);t.length>=e;)e=n.consume(t.read(e)),n.ready&&a.enqueue(n.next())},flush(s){n.ready&&s.enqueue(n.next())}})}H.parseDisplaySets=x;function y(n,t){let e=0,s=0,a=0;const h=n.length;for(;e<h;){const m=n.at(e);let u,g,b;if(m>0)g=m,u=1,b=1;else{const p=n.at(e+1);if(p===0)g=0,u=0,b=2,s=0,++a;else if(p<64)g=0,u=p,b=2;else if(p<128){const w=n.at(e+2);g=0,u=(p-64<<8)+w,b=3}else if(p<192)g=n.at(e+2),u=p-128,b=3;else{const w=n.at(e+2);g=n.at(e+3),u=(p-192<<8)+w,b=4}}if(u>0){for(let p=s;p<s+u;++p)t(p,a,g);s+=u}e+=b}}class o{constructor(t,e,s,a,h,m){this.presentationCompositionSegment=t,this.windowDefinitionSegments=e,this.paletteDefinitionSegments=s,this.objectDefinitionSegments=a,this.endDefinitionSegment=h,this.previousDisplaySet=m}get firstOds(){return this.objectDefinitionSegments.find(t=>t.lastInSequenceFlag===r.LastInSequenceFlag.firstInSequence||t.lastInSequenceFlag===r.LastInSequenceFlag.firstAndLastInSequence)}paletteDefinitionSegment(t){const e=this.paletteDefinitionSegments.find(s=>s.paletteId===t);if(e===void 0){if(this.presentationCompositionSegment.compositionState!==r.CompositionState.normal)throw new Error("PCS references invalid PDS and composition state is not 'normal'");if(this.previousDisplaySet===void 0)throw new Error("PCS references invalid PDS and no previous display set to fallback to");return this.previousDisplaySet.paletteDefinitionSegment(t)}return e}imageData(t){const e=this.paletteDefinitionSegment(this.presentationCompositionSegment.paletteId);if(e===void 0)throw new Error("PCS references invalid PDS");const s=this.firstOds;if(s===void 0||s.width===void 0||s.height===void 0)throw new Error("Missing first ODS with defined width and height");const a=t??new Uint8ClampedArray(s.width*s.height*4),h=e.paletteEntries.map(u=>this.ycrcbToRgba(u)),m=s.width;return y(new i.CompositeBuffer(this.objectDefinitionSegments.map(u=>u.objectData)),(u,g,b)=>{const w=(g*m+u)*4;if(b>=h.length)a[w]=0,a[w+1]=0,a[w+2]=0,a[w+3]=0;else{const I=h[b];a[w]=I.r,a[w+1]=I.g,a[w+2]=I.b,a[w+3]=I.a}}),new ImageData(a.subarray(0,4*s.width*s.height),s.width,s.height)}ycrcbToRgba(t){const e=t.luminance,s=t.colorDifferenceBlue,a=t.colorDifferenceRed,h=this.clamp(Math.floor(e+1.4075*(a-128)),0,255),m=this.clamp(Math.floor(e-.3455*(s-128)-.7169*(a-128)),0,255),u=this.clamp(Math.floor(e+1.779*(s-128)),0,255);return{r:h,g:m,b:u,a:t.transparency}}clamp(t,e,s){return Math.max(e,Math.min(s,t))}}H.DisplaySet=o;class f{constructor(){this.windowDefinitionSegments=[],this.paletteDefinitionSegments=[],this.objectDefinitionSegments=[],this.ready=!1}next(){return this.ready=!1,this.lastDisplaySet}consume(t){const e=new i.BufferReader(t);if(this.header){switch(this.header.segmentType){case r.SegmentType.pcs:if(this.presentationCompositionSegment!==void 0)throw new Error("Unexpected PDS");this.presentationCompositionSegment=l(e,this.header);break;case r.SegmentType.wds:if(this.presentationCompositionSegment===void 0)throw new Error("Unexpected WDS");this.windowDefinitionSegments.push(c(e,this.header));break;case r.SegmentType.pds:if(this.presentationCompositionSegment===void 0)throw new Error("Unexpected PDS");this.paletteDefinitionSegments.push(S(e,this.header));break;case r.SegmentType.ods:if(this.presentationCompositionSegment===void 0)throw new Error("Unexpected ODS");const s=B(e,this.header);this.objectDefinitionSegments.push(s);break;case r.SegmentType.end:if(this.presentationCompositionSegment===void 0)throw new Error("Unexpected end segment");const a={header:this.header};this.lastDisplaySet=new o(this.presentationCompositionSegment,this.windowDefinitionSegments,this.paletteDefinitionSegments,this.objectDefinitionSegments,a,this.lastDisplaySet),this.ready=!0,this.presentationCompositionSegment=void 0,this.windowDefinitionSegments=[],this.paletteDefinitionSegments=[],this.objectDefinitionSegments=[];break;default:throw new Error(`Unknown segment type: ${this.header.segmentType}`)}return this.header=void 0,13}else{const s=e.readHex(2);if(s!==d)throw new Error(`Invalid magic number: ${s}`);const a=e.readHex(4),h=e.readHex(4),m=(0,r.segmentTypeFromByte)(e.readHex(1)),u=e.readHex(2);return this.header={presentationTimestamp:a,decodingTimestamp:h,segmentType:m,segmentSize:u},u}}}function l(n,t){const e=n.index+t.segmentSize,s=n.readHex(2,e),a=n.readHex(2,e);n.readHex(1);const h=n.readHex(2,e),m=(0,r.compositionStateFromByte)(n.readHex(1,e)),u=(0,r.paletteUpdateFlagFromByte)(n.readHex(1,e)),g=n.readHex(1,e),b=n.readHex(1,e),p=n.readHex(2,e),w=n.readHex(1,e),I=(0,r.objectCroppedFlagFromByte)(n.readHex(1,e)),R=n.readHex(2,e),U=n.readHex(2,e),k=n.readHex(2,e),A=n.readHex(2,e),V=n.readHex(2,e),z=n.readHex(2,e);return{header:t,width:s,height:a,compositionNumber:h,compositionState:m,paletteUpdateFlag:u,paletteId:g,compositionObjectCount:b,objectId:p,windowId:w,objectCroppedFlag:I,objectHorizontalPosition:R,objectVerticalPosition:U,objectCroppingHorizontalPosition:k,objectCroppingVerticalPosition:A,objectCroppingWidth:V,objectCroppingHeightPosition:z}}function c(n,t){const e=n.index+t.segmentSize,s=n.readHex(1,e),a=[];for(let h=0;h<s;++h){const m=n.readHex(1,e),u=n.readHex(2,e),g=n.readHex(2,e),b=n.readHex(2,e),p=n.readHex(2,e);a.push({windowId:m,windowHorizontalPosition:u,windowVerticalPosition:g,windowWidth:b,windowHeight:p})}return{header:t,windowCount:s,windowDefinitions:a}}function S(n,t){const e=n.index+t.segmentSize,s=n.readHex(1,e),a=n.readHex(1,e),h=[];for(;n.index<e;){const m=n.readHex(1,e),u=n.readHex(1,e),g=n.readHex(1,e),b=n.readHex(1,e),p=n.readHex(1,e);h.push({paletteEntryId:m,luminance:u,colorDifferenceRed:g,colorDifferenceBlue:b,transparency:p})}return{header:t,paletteId:s,paletteVersionNumber:a,paletteEntries:h}}function B(n,t){const e=n.readHex(2),s=n.readHex(1),a=(0,r.lastInSequenceFlagFromByte)(n.readHex(1)),h=n.readHex(3);let m,u,g;return a===r.LastInSequenceFlag.firstInSequence||a===r.LastInSequenceFlag.firstAndLastInSequence?(m=n.readHex(2),u=n.readHex(2),g=n.readBuffer(h-4)):g=n.readBuffer(h),{header:t,objectId:e,objectVersionNumber:s,lastInSequenceFlag:a,objectDataLength:h,width:m,height:u,objectData:g}}return H}var E;function _(){return E||(E=1,function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.LastInSequenceFlag=i.CompositionState=i.SegmentType=i.DisplaySet=i.parseDisplaySets=void 0;var r=O();Object.defineProperty(i,"parseDisplaySets",{enumerable:!0,get:function(){return r.parseDisplaySets}}),Object.defineProperty(i,"DisplaySet",{enumerable:!0,get:function(){return r.DisplaySet}});var d=q();Object.defineProperty(i,"SegmentType",{enumerable:!0,get:function(){return d.SegmentType}}),Object.defineProperty(i,"CompositionState",{enumerable:!0,get:function(){return d.CompositionState}}),Object.defineProperty(i,"LastInSequenceFlag",{enumerable:!0,get:function(){return d.LastInSequenceFlag}})}(v)),v}var L=_();function M(i,r){let d,x;i.pipeThrough(L.parseDisplaySets()).pipeTo(new WritableStream({close(){postMessage({command:"finished"})},abort(y){postMessage({command:"error",error:y})},async write(y,o){if(y.objectDefinitionSegments.length>0)d===void 0&&(d=y);else if(d!==void 0){const f=d.presentationCompositionSegment.width,l=d.presentationCompositionSegment.height;x=x===void 0||x.length<l*f*4?new Uint8ClampedArray(f*l*4):x;const c=d.imageData(x);r.width=c.width,r.height=c.height,r.getContext("2d").putImageData(c,0,0),postMessage({command:"subtitle",imageBlob:await r.convertToBlob({type:"image/png"}),subtitle:{start:d.objectDefinitionSegments[0].header.presentationTimestamp/90,end:y.endDefinitionSegment.header.presentationTimestamp/90,text:"",textImage:{image:{width:c.width,height:c.height},screen:{width:d.presentationCompositionSegment.width,height:d.presentationCompositionSegment.height}}}}),d=void 0}}}))}onmessage=async i=>{const{fileStream:r,canvas:d}=i.data;M(r,d)}})();
